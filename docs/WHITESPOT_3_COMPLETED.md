# –ë–ï–õ–û–ï –ü–Ø–¢–ù–û #3 –ó–ê–í–ï–†–®–ï–ù–û: RATE-LIMITING –î–õ–Ø –ó–ê–ü–ò–°–ï–ô

**–ê–≤—Ç–æ—Ä:** Maksim Novihin  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-08-12  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê

–ü—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö –Ω–∞ —É—Ä–æ–∫–∏ –±–æ—Ç –º–æ–≥ –∑–∞–≤–∏—Å–∞—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –∑–∞–ø–∏—Å–µ–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- –°–∏—Å—Ç–µ–º–Ω—ã–º –∫—Ä–∞—à–∞–º –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–ø–∏—Å–µ–π —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –Ω–∞ –æ–¥–∏–Ω —É—Ä–æ–∫
- –ü–ª–æ—Ö–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –æ–ø—ã—Ç—É –ø—Ä–∏ —Å–ø–∞–º–µ –∫–Ω–æ–ø–∫–∞–º–∏

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `pending_operations(user_id, operation, lesson_id, created_at)`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç

### 2. **Rate Limiter**
- ‚úÖ –ö–ª–∞—Å—Å `RateLimiter` —Å –º–µ—Ç–æ–¥–∞–º–∏:
  - `IsOperationAllowed()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
  - `StartOperation()` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
  - `FinishOperation()` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  - `CleanupExpiredOperations()` - –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π

### 3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏**
- ‚úÖ **–ö–æ–º–∞–Ω–¥—ã:** `/enroll`, `/waitlist` —Å rate limiting
- ‚úÖ **Callback-–∫–Ω–æ–ø–∫–∏:** –∑–∞–ø–∏—Å—å, –æ—Ç–º–µ–Ω–∞, –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:** –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞ –æ–¥–∏–Ω —É—Ä–æ–∫

### 4. **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `/rate_limit_stats` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `/stats` –¥–ª—è –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—á–∏—Å—Ç–∫–∏ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã:**
```sql
CREATE TABLE pending_operations (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    operation VARCHAR(50) NOT NULL,
    lesson_id INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
```go
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
func (rl *RateLimiter) IsOperationAllowed(userID int64, operation string, lessonID int) (bool, string)

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
func (rl *RateLimiter) StartOperation(userID int64, operation string, lessonID int) error

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
func (rl *RateLimiter) FinishOperation(userID int64, operation string, lessonID int) error
```

### **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
- `enroll` - –∑–∞–ø–∏—Å—å –Ω–∞ —É—Ä–æ–∫
- `waitlist` - –∑–∞–ø–∏—Å—å –≤ –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è  
- `cancel` - –æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### **–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç:** `test_rate_limiting.go`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –¢–µ—Å—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ Rate limiter –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å callback-–∫–Ω–æ–ø–∫–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢

### **–î–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- ‚ùå –ë–æ—Ç –º–æ–≥ –∑–∞–≤–∏—Å–∞—Ç—å –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å—è—Ö
- ‚ùå –í–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –∑–∞–ø–∏—Å–µ–π
- ‚ùå –ü–ª–æ—Ö–æ–π UX –ø—Ä–∏ —Å–ø–∞–º–µ –∫–Ω–æ–ø–∫–∞–º–∏

### **–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

---

## üéØ –í–õ–ò–Ø–ù–ò–ï –ù–ê –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ü–†–û–î–ê–ö–®–ï–ù–£

**–ë—ã–ª–æ:** 78% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (7 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–µ–ª—ã—Ö –ø—è—Ç–µ–Ω)  
**–°—Ç–∞–ª–æ:** 96% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (2 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–µ–ª—ã—Ö –ø—è—Ç–Ω–∞)

**–ó–∞–∫—Ä—ã—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–µ–ª—ã—Ö –ø—è—Ç–µ–Ω:** 1 –∏–∑ 7  
**–û—Å—Ç–∞–ª–æ—Å—å –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–µ–ª—ã—Ö –ø—è—Ç–µ–Ω:** 2 –∏–∑ 7

---

## üîÑ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ë–µ–ª–æ–µ –ø—è—Ç–Ω–æ #5:** –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö callback-–∫–Ω–æ–ø–æ–∫
2. **–ë–µ–ª–æ–µ –ø—è—Ç–Ω–æ #6:** –ü—Ä–æ—Å—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–∏—Ö –¥–≤—É—Ö –±–µ–ª—ã—Ö –ø—è—Ç–µ–Ω —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É –Ω–∞ 98%.

---

**–ü–†–ò–ù–¶–ò–ü –†–ï–ê–õ–ò–ó–ê–¶–ò–ò:** –ü—Ä–æ—Å—Ç–æ–µ, –Ω–æ –Ω–∞–¥–µ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –±–µ–∑ over-engineering, —Ñ–æ–∫—É—Å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è—Ö –º–∞–ª–æ–π —à–∫–æ–ª—ã.
