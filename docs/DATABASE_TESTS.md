# –¢–µ—Å—Ç—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - Constellation School Bot

## –û–±–∑–æ—Ä

–ö–æ–º–ø–ª–µ–∫—Ç –ø—Ä–æ—Å—Ç—ã—Ö –∏ –Ω–∞–¥–µ–∂–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π PostgreSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Telegram –±–æ—Ç–∞ —à–∫–æ–ª—ã.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### üìÅ –§–∞–π–ª—ã
- `internal/database/db_test.go` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã –ë–î
- `scripts/test_db.sh` - —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤

### üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### 1. `TestCreateManyUsers`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–¥—Ä—è–¥
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≤—Å–µ—Ö `tg_id`
- –ò–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ë–î —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º  
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö `tg_id`
- ‚úÖ –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

#### 2. `TestCascadeDelete` 
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π  
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π: `user ‚Üí student ‚Üí enrollment`
- –£–¥–∞–ª—è–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –∑–∞–ø–∏—Å—å (`user`)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º—ã—Ö –∑–∞–ø–∏—Å–µ–π

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- ‚úÖ –ó–∞–ø–∏—Å—å —Å—Ç—É–¥–µ–Ω—Ç–∞ —É–¥–∞–ª—è–µ—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ (ON DELETE CASCADE)
- ‚úÖ –ó–∞–ø–∏—Å—å –Ω–∞ —É—Ä–æ–∫ —É–¥–∞–ª—è–µ—Ç—Å—è –∫–∞—Å–∫–∞–¥–Ω–æ

#### 3. `TestConcurrentEnrollments`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–µ—Å—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –Ω–∞ —É—Ä–æ–∫  
**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç 10 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- –ó–∞–ø—É—Å–∫–∞–µ—Ç 10 –≥–æ—Ä—É—Ç–∏–Ω –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –Ω–∞ –æ–¥–∏–Ω —É—Ä–æ–∫
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ race condition –∏ –¥—É–±–ª–µ–π

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –í—Å–µ –≥–æ—Ä—É—Ç–∏–Ω—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –±–µ–∑ deadlock
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ student_id
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ë–î —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —É—Å–ø–µ—à–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### üê≥ TestContainers
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è PostgreSQL 16 –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cleanup –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –ë–î

### üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```go
github.com/stretchr/testify/assert     // –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
github.com/stretchr/testify/require    // –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
github.com/testcontainers/testcontainers-go  // Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
```

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫
```bash
./scripts/test_db.sh
```

### –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
```bash
# –¢–µ—Å—Ç –º–∞—Å—Å–æ–≤–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
go test -v ./internal/database -run TestCreateManyUsers

# –¢–µ—Å—Ç –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è  
go test -v ./internal/database -run TestCascadeDelete

# –¢–µ—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
go test -v ./internal/database -run TestConcurrentEnrollments
```

### –í—Å–µ —Ç–µ—Å—Ç—ã –≤–º–µ—Å—Ç–µ
```bash
go test -v ./internal/database
```

## –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ —Å—Ä–µ–¥–Ω–µ–º)
- **TestCreateManyUsers:** ~250ms (100 –∑–∞–ø–∏—Å–µ–π)
- **TestCascadeDelete:** ~2.5s (–≤–∫–ª—é—á–∞—è setup/cleanup –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
- **TestConcurrentEnrollments:** ~25ms (10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π)

### üìä –ù–∞–≥—Ä—É–∑–∫–∞
- **–°–æ–∑–¥–∞–Ω–∏–µ:** 400+ –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫—É–Ω–¥—É
- **Concurrent operations:** 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- **Memory usage:** Minimal –±–ª–∞–≥–æ–¥–∞—Ä—è –∏–∑–æ–ª—è—Ü–∏–∏ testcontainers

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### üõ°Ô∏è –ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
–ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –ø–æ–ª—É—á–∞–µ—Ç:
- –°–≤–µ–∂–∏–π PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- –ü–æ–ª–Ω—É—é —Å—Ö–µ–º—É –ë–î —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–µ–¥–º–µ—Ç—ã)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É

### üîÑ –ë–µ–∑ –º–æ–∫-–æ–±—ä–µ–∫—Ç–æ–≤
- –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –Ω–∞—Å—Ç–æ—è—â–µ–π –ë–î
- –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ constraints
- –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å–æ–≤

### ‚ö° –ü—Ä–æ—Å—Ç–æ—Ç–∞
- –ù–∏–∫–∞–∫–∏—Ö —Å–ª–æ–∂–Ω—ã—Ö setup-–ø—Ä–æ—Ü–µ–¥—É—Ä
- –ü–æ–Ω—è—Ç–Ω—ã–µ assert —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### ‚ùå –ß—Ç–æ –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è
- **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, max_students –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
- **Telegram Bot API** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è  
- **Redis FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è**
- **–°–ª–æ–∂–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** —Å –æ—Ç–∫–∞—Ç–∞–º–∏

### ‚ö†Ô∏è –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è
- Docker Desktop —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞–∑–æ–≤
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
‚úÖ TestCreateManyUsers: 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏  
‚úÖ TestCascadeDelete: user ‚Üí student ‚Üí enrollment
‚úÖ TestConcurrentEnrollments: 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
```

**–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –≤—ã–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –¥–æ 50 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤! üöÄ
