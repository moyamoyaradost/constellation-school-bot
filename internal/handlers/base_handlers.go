package handlers

import (
	"database/sql"
	"strconv"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏
func handleHelp(bot *tgbotapi.BotAPI, message *tgbotapi.Message, db *sql.DB) {
	userID := message.From.ID
	
	// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	var role string
	err := db.QueryRow("SELECT role FROM users WHERE tg_id = $1", 
		strconv.FormatInt(userID, 10)).Scan(&role)
	
	var helpText string
	
	if err == sql.ErrNoRows {
		// –ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
		helpText = "üÜò –ü–æ–º–æ—â—å - Constellation School Bot\n\n" +
			"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n\n" +
			"üìù –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n" +
			"/start - –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n" +
			"/register - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ\n" +
			"/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n" +
			"üéØ –û –¶–µ–Ω—Ç—Ä–µ –¶–∏—Ñ—Ä–æ–≤–æ–≥–æ –¢–≤–æ—Ä—á–µ—Å—Ç–≤–∞:\n" +
			"–ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º 6 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ–±—É—á–µ–Ω–∏—è:\n" +
			"‚Ä¢ 3D-–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ\n" +
			"‚Ä¢ –ì–µ–π–º–¥–µ–≤\n" +
			"‚Ä¢ VFX-–¥–∏–∑–∞–π–Ω\n" +
			"‚Ä¢ –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω\n" +
			"‚Ä¢ –í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\n" +
			"‚Ä¢ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å"
			
	} else if err != nil {
		helpText = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"
		
	} else {
		switch role {
		case "student":
			helpText = "üÜò **–ü–æ–º–æ—â—å –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤**\n\n" +
				"üìö **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n" +
				"‚Ä¢ `/start` - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏\n" +
				"‚Ä¢ `/menu` - –±—ã—Å—Ç—Ä—ã–π –≤—ã–∑–æ–≤ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é\n" +
				"‚Ä¢ `/schedule` - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤ —à–∫–æ–ª—ã\n" +
				"‚Ä¢ `/my_lessons` - –º–æ–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Ä–æ–∫–∏\n" +
				"‚Ä¢ `/enroll` - –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É—Ä–æ–∫\n" +
				"‚Ä¢ `/waitlist` - –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è\n" +
				"‚Ä¢ `/help` - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n" +
				"üéØ **–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É—Ä–æ–∫:**\n" +
				"1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é\n" +
				"2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∫–Ω–æ–ø–∫–∞–º–∏\n" +
				"3. –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö\n" +
				"4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–ø–∏—Å—å\n\n" +
				"üí° **–ü–æ–¥—Å–∫–∞–∑–∫–∞:** ID —É—Ä–æ–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –∫–∞–∫ #123"
				
		case "teacher":
			helpText = "üÜò **–ü–æ–º–æ—â—å –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π**\n\n" +
				"üë®‚Äçüè´ **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n" +
				"‚Ä¢ `/start` - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏\n" +
				"‚Ä¢ `/menu` - –±—ã—Å—Ç—Ä—ã–π –≤—ã–∑–æ–≤ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é\n" +
				"‚Ä¢ `/my_schedule` - –º–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é\n" +
				"‚Ä¢ `/my_students` - —Å—Ç—É–¥–µ–Ω—Ç—ã –º–æ–∏—Ö —É—Ä–æ–∫–æ–≤\n" +
				"‚Ä¢ `/create_lesson` - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —É—Ä–æ–∫\n" +
				"‚Ä¢ `/cancel_lesson` - –æ—Ç–º–µ–Ω–∏—Ç—å —É—Ä–æ–∫\n" +
				"‚Ä¢ `/help_teacher` - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞\n" +
				"‚Ä¢ `/help` - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n" +
				"üéØ **–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫:**\n" +
				"1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '‚ûï –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫'\n" +
				"2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∫–Ω–æ–ø–∫–∞–º–∏\n" +
				"3. –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è\n" +
				"4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ\n\n" +
				"üóëÔ∏è **–ö–∞–∫ –æ—Ç–º–µ–Ω–∏—Ç—å —É—Ä–æ–∫:**\n" +
				"1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 'üóëÔ∏è –û—Ç–º–µ–Ω–∏—Ç—å —É—Ä–æ–∫'\n" +
				"2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ —É—Ä–æ–∫\n" +
				"3. –°—Ç—É–¥–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
				
		case "superuser":
			helpText = "üÜò **–ü–æ–º–æ—â—å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤**\n\n" +
				"üîß **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∏—Ç–µ–ª—è–º–∏:**\n" +
				"‚Ä¢ `/add_teacher` - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è\n" +
				"‚Ä¢ `/delete_teacher` - —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è\n" +
				"‚Ä¢ `/restore_teacher` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è\n" +
				"‚Ä¢ `/list_teachers` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π\n\n" +
				"üìö **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–∫–∞–º–∏:**\n" +
				"‚Ä¢ `/create_lesson` - —Å–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫\n" +
				"‚Ä¢ `/delete_lesson` - —É–¥–∞–ª–∏—Ç—å —É—Ä–æ–∫\n" +
				"‚Ä¢ `/restore_lesson` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ä–æ–∫\n" +
				"‚Ä¢ `/reschedule_lesson` - –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —É—Ä–æ–∫\n\n" +
				"üë• **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏:**\n" +
				"‚Ä¢ `/deactivate_student` - –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞\n" +
				"‚Ä¢ `/activate_student` - —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞\n\n" +
				"üì¢ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**\n" +
				"‚Ä¢ `/notify_all` - —É–≤–µ–¥–æ–º–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n" +
				"‚Ä¢ `/notify_students` - —É–≤–µ–¥–æ–º–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —É—Ä–æ–∫–∞\n" +
				"‚Ä¢ `/remind_all` - –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —É—Ä–æ–∫–∞—Ö\n" +
				"‚Ä¢ `/cancel_with_notification` - –æ—Ç–º–µ–Ω–∏—Ç—å —É—Ä–æ–∫ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º\n\n" +
				"üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ª–æ–≥–∏:**\n" +
				"‚Ä¢ `/stats` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã\n" +
				"‚Ä¢ `/rate_limit_stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π\n" +
				"‚Ä¢ `/log_recent_errors` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–∏—Å—Ç–µ–º—ã\n\n" +
				"‚Ä¢ `/help` - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
				
		default:
			helpText = "üÜò –ü–æ–º–æ—â—å\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã"
		}
	}
	
	msg := tgbotapi.NewMessage(message.Chat.ID, helpText)
	bot.Send(msg)
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
func handleStudentCallback(bot *tgbotapi.BotAPI, query *tgbotapi.CallbackQuery, db *sql.DB) {
	// –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
	sendMessage(bot, query.Message.Chat.ID, "‚öôÔ∏è –§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –æ—Ç–º–µ–Ω—ã —É—Ä–æ–∫–æ–≤
func handleCancelLessonCallback(bot *tgbotapi.BotAPI, query *tgbotapi.CallbackQuery, db *sql.DB) {
	// –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã —É—Ä–æ–∫–æ–≤
	sendMessage(bot, query.Message.Chat.ID, "‚öôÔ∏è –û—Ç–º–µ–Ω–∞ —É—Ä–æ–∫–∞ - —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
}
