package handlers

import (
	"database/sql"
	"strconv"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏
func handleHelp(bot *tgbotapi.BotAPI, message *tgbotapi.Message, db *sql.DB) {
	userID := message.From.ID
	
	// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	var role string
	err := db.QueryRow("SELECT role FROM users WHERE tg_id = $1", 
		strconv.FormatInt(userID, 10)).Scan(&role)
	
	var helpText string
	
	if err == sql.ErrNoRows {
		// –ù–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
		helpText = "üÜò –ü–æ–º–æ—â—å - Constellation School Bot\n\n" +
			"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n\n" +
			"üìù –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n" +
			"/start - –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n" +
			"/register - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ\n" +
			"/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n" +
			"üéØ –û –¶–µ–Ω—Ç—Ä–µ –¶–∏—Ñ—Ä–æ–≤–æ–≥–æ –¢–≤–æ—Ä—á–µ—Å—Ç–≤–∞:\n" +
			"–ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º 6 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ–±—É—á–µ–Ω–∏—è:\n" +
			"‚Ä¢ 3D-–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ\n" +
			"‚Ä¢ –ì–µ–π–º–¥–µ–≤\n" +
			"‚Ä¢ VFX-–¥–∏–∑–∞–π–Ω\n" +
			"‚Ä¢ –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω\n" +
			"‚Ä¢ –í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\n" +
			"‚Ä¢ –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å"
			
	} else if err != nil {
		helpText = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"
		
	} else {
		switch role {
		case "student":
			helpText = "üÜò –ü–æ–º–æ—â—å –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤\n\n" +
				"üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n" +
				"/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n" +
				"/subjects - –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã\n" +
				"/schedule - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤\n" +
				"/enroll - –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É—Ä–æ–∫\n" +
				"/my_lessons - –º–æ–∏ –∑–∞–ø–∏—Å–∏\n" +
				"/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
				
		case "teacher":
			helpText = "üÜò –ü–æ–º–æ—â—å –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π\n\n" +
				"üë®‚Äçüè´ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n" +
				"/create_lesson - —Å–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫\n" +
				"/cancel_lesson - –æ—Ç–º–µ–Ω–∏—Ç—å —É—Ä–æ–∫\n" +
				"/my_students - –º–æ–∏ —Å—Ç—É–¥–µ–Ω—Ç—ã\n" +
				"/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
				
		case "superuser":
			helpText = "üÜò –ü–æ–º–æ—â—å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤\n\n" +
				"üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n" +
				"/add_teacher - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è\n" +
				"/delete_teacher - —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è\n" +
				"/notify_students - —É–≤–µ–¥–æ–º–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤\n" +
				"/create_lesson - —Å–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫\n" +
				"/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
				
		default:
			helpText = "üÜò –ü–æ–º–æ—â—å\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã"
		}
	}
	
	msg := tgbotapi.NewMessage(message.Chat.ID, helpText)
	bot.Send(msg)
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
func handleStudentCallback(bot *tgbotapi.BotAPI, query *tgbotapi.CallbackQuery, db *sql.DB) {
	// –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
	sendMessage(bot, query.Message.Chat.ID, "‚öôÔ∏è –§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –æ—Ç–º–µ–Ω—ã —É—Ä–æ–∫–æ–≤
func handleCancelLessonCallback(bot *tgbotapi.BotAPI, query *tgbotapi.CallbackQuery, db *sql.DB) {
	// –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã —É—Ä–æ–∫–æ–≤
	sendMessage(bot, query.Message.Chat.ID, "‚öôÔ∏è –û—Ç–º–µ–Ω–∞ —É—Ä–æ–∫–∞ - —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
}
