package handlers

import (
	"database/sql"
	"log"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// Основной обработчик сообщений
func HandleUpdate(bot *tgbotapi.BotAPI, update tgbotapi.Update, db *sql.DB) {
	if update.Message != nil {
		handleMessage(bot, update.Message, db)
	} else if update.CallbackQuery != nil {
		handleCallbackQuery(bot, update.CallbackQuery, db)
	}
}

// Обработка текстовых сообщений
func handleMessage(bot *tgbotapi.BotAPI, message *tgbotapi.Message, db *sql.DB) {
	if message.IsCommand() {
		handleCommand(bot, message, db)
	} else {
		// Обработка текста через FSM
		handleTextMessage(bot, message, db)
	}
}

// Маршрутизация команд
func handleCommand(bot *tgbotapi.BotAPI, message *tgbotapi.Message, db *sql.DB) {
	switch message.Command() {
	case "start":
		handleStart(bot, message, db)
	case "register":
		handleRegister(bot, message, db)
	case "help":
		handleHelp(bot, message, db)
	case "subjects", "schedule", "enroll", "waitlist", "my_lessons":
		handleStudentCommand(bot, message, db)
	case "create_lesson", "reschedule_lesson", "cancel_lesson":
		handleTeacherCommand(bot, message, db)
	case "add_teacher", "delete_teacher", "notify_students", "my_students":
		handleAdminCommand(bot, message, db)
	default:
		sendMessage(bot, message.Chat.ID, 
			"❓ Неизвестная команда. Используйте /help для получения списка доступных команд.")
	}
}

// Маршрутизация callback запросов
func handleCallbackQuery(bot *tgbotapi.BotAPI, query *tgbotapi.CallbackQuery, db *sql.DB) {
	// Убрать индикатор загрузки
	callback := tgbotapi.NewCallback(query.ID, "")
	if _, err := bot.Request(callback); err != nil {
		log.Printf("Ошибка callback ответа: %v", err)
	}

	if query.Data == "cancel_lesson" {
		handleCancelLessonCallback(bot, query, db)
	} else {
		handleStudentCallback(bot, query, db)
	}
}
